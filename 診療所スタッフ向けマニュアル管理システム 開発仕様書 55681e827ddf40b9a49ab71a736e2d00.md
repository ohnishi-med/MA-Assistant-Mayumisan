# 診療所スタッフ向けマニュアル管理システム 開発仕様書

## プロジェクト概要

診療所スタッフが効率的にマニュアルを作成・参照できる管理システムの開発。

### 核心コンセプト

**多経路アクセス設計**

- 同一マニュアルに複数のナビゲーション経路からアクセス可能
- 例：労災マニュアルに「受付→保険→労災」「会計→労災」両方からアクセス

**動的フローチャート表示**

- アクセス経路に応じて該当セクションを自動強調
- 受付経路からは受付フロー、会計経路からは会計フローを強調表示

**AI支援タグ付け**

- マニュアル作成時に関連カテゴリを自動提案
- ユーザーの手動タグ付け負荷を軽減

### ターゲットユーザー

- 医療事務スタッフ
- 看護師
- 臨床工学技士（ME）
- 透析クラーク
- 院長秘書

## データ構造設計

### カテゴリテーブル（再帰的構造）

```sql
CREATE TABLE categories (
  id SERIAL PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  parent_id INTEGER REFERENCES categories(id),
  level INTEGER CHECK (level BETWEEN 1 AND 5),
  path TEXT, -- 例: "1/3/7"
  display_order INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_categories_parent ON categories(parent_id);
CREATE INDEX idx_categories_path ON categories(path);
```

**階層設計**

- 技術的上限：5階層
- 推奨運用：2〜3階層
    - L1: 大分類（受付、会計、診療補助、レセプト、書類管理など）
    - L2: 中分類（保険、送迎、検査、薬剤など）
    - L3: 詳細（労災、社保、国保など）

### マニュアルテーブル

```sql
CREATE TABLE manuals (
  id SERIAL PRIMARY KEY,
  title VARCHAR(500) NOT NULL,
  content TEXT, -- Markdown形式
  flowchart_data JSONB, -- フローチャート定義
  version INTEGER DEFAULT 1,
  status VARCHAR(20) DEFAULT 'draft', -- draft/published/archived
  created_by INTEGER REFERENCES users(id),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_manuals_status ON manuals(status);
```

### 画像管理テーブル

```sql
CREATE TABLE manual_images (
  id SERIAL PRIMARY KEY,
  manual_id INTEGER REFERENCES manuals(id) ON DELETE CASCADE,
  file_name VARCHAR(255) NOT NULL,
  file_path TEXT NOT NULL,
  file_size INTEGER,
  mime_type VARCHAR(100),
  alt_text TEXT,
  display_order INTEGER DEFAULT 0,
  uploaded_by INTEGER REFERENCES users(id),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_manual_images_manual ON manual_images(manual_id);
```

**フローチャートデータ構造（JSON）**

```json
{
  "nodes": [
    {
      "id": "reception",
      "label": "受付で患者情報確認",
      "type": "process",
      "position": {"x": 100, "y": 100},
      "data": {
        "description": "患者氏名、生年月日、住所を確認",
        "imageId": null
      }
    },
    {
      "id": "insurance_check",
      "label": "保険証を持参しているか？",
      "type": "decision",
      "position": {"x": 100, "y": 200},
      "data": {
        "description": "保険証の有無を確認"
      }
    },
    {
      "id": "insurance_registration",
      "label": "保険情報登録",
      "type": "process",
      "position": {"x": 50, "y": 300}
    },
    {
      "id": "self_pay",
      "label": "自費診療として処理",
      "type": "process",
      "position": {"x": 250, "y": 300}
    },
    {
      "id": "accounting",
      "label": "会計処理",
      "type": "process",
      "position": {"x": 100, "y": 400}
    }
  ],
  "edges": [
    {"id": "e1", "source": "reception", "target": "insurance_check"},
    {"id": "e2", "source": "insurance_check", "target": "insurance_registration", "label": "はい"},
    {"id": "e3", "source": "insurance_check", "target": "self_pay", "label": "いいえ"},
    {"id": "e4", "source": "insurance_registration", "target": "accounting"},
    {"id": "e5", "source": "self_pay", "target": "accounting"}
  ]
}
```

**ノードタイプ**

- `process`: 通常の処理ステップ（長方形）
- `decision`: 分岐判断（ひし形）
- `start`: 開始ノード（丸）
- `end`: 終了ノード（丸）

### カテゴリ・マニュアル関連テーブル

```sql
CREATE TABLE category_manuals (
  id SERIAL PRIMARY KEY,
  category_id INTEGER REFERENCES categories(id) ON DELETE CASCADE,
  manual_id INTEGER REFERENCES manuals(id) ON DELETE CASCADE,
  entry_point VARCHAR(100), -- フローチャート内の強調ノードID
  display_order INTEGER DEFAULT 0,
  UNIQUE(category_id, manual_id)
);

CREATE INDEX idx_category_manuals_category ON category_manuals(category_id);
CREATE INDEX idx_category_manuals_manual ON category_manuals(manual_id);
```

### タグテーブル

```sql
CREATE TABLE tags (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100) NOT NULL UNIQUE,
  color VARCHAR(20),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE manual_tags (
  manual_id INTEGER REFERENCES manuals(id) ON DELETE CASCADE,
  tag_id INTEGER REFERENCES tags(id) ON DELETE CASCADE,
  PRIMARY KEY (manual_id, tag_id)
);
```

## UI設計

### ナビゲーション画面

**階層的ブラウジング**

```
┌─ 受付 ─────────────┐
│ ├ 患者登録        │
│ ├ 保険            │
│ │ ├ 社会保険      │
│ │ ├ 国民健康保険  │
│ │ └ 労災保険 ★   │
│ └ 予約管理        │
└───────────────────┘

┌─ 会計 ─────────────┐
│ ├ 保険請求        │
│ ├ 労災保険 ★     │
│ └ 自費診療        │
└───────────────────┘
```

### マニュアル表示画面

**構成要素**

1. **パンくずリスト**
    - 受付 > 保険 > 労災保険 > マニュアルA
2. **動的フローチャート**
    - アクセス経路に応じて該当セクションをハイライト
    - 例：`?from=reception&node=reception` で受付ノードを強調
3. **本文コンテンツ**
    - Markdown レンダリング
    - 画像ギャラリー表示（アップロード、削除、並び替え）
    - 画像をドラッグ&ドロップでアップロード
    - 動画埋め込み対応
4. **関連マニュアルリンク**
    - 同じカテゴリの他マニュアル
    - タグベースのレコメンド
5. **複数ルート管理UI**
    - 「＋ カテゴリに追加」ボタン
    - 現在登録されているカテゴリ一覧表示
    - 各カテゴリのentry_point（強調ノード）設定
    - カテゴリ削除ボタン

### 複数ルート管理機能

**UI設計**

```
┌─ マニュアル編集画面 ─────────────────────┐
│ タイトル: 労災保険処理マニュアル          │
│                                          │
│ [本文]  [フローチャート]  [カテゴリ管理] │
│                                          │
│ ▼ 登録済みカテゴリ                       │
│ ┌────────────────────────────────┐     │
│ │ 📁 受付 > 保険 > 労災            │     │
│ │    強調ノード: reception         │ [✕] │
│ ├────────────────────────────────┤     │
│ │ 📁 会計 > 労災                   │     │
│ │    強調ノード: accounting        │ [✕] │
│ └────────────────────────────────┘     │
│                                          │
│ [＋ カテゴリに追加]                      │
└──────────────────────────────────────┘
```

**カテゴリ追加モーダル仕様**

- カテゴリツリーから選択（階層表示）
- フローチャートノードから強調ノードを選択
- 追加ボタンでcategory_manualsテーブルに登録

**API仕様**

- `POST /api/manuals/:manualId/categories`: カテゴリ追加
- `GET /api/manuals/:manualId/categories`: 登録済みカテゴリ一覧
- `DELETE /api/manuals/:manualId/categories/:categoryId`: カテゴリ削除

**AI一括カテゴリ提案**

- マニュアル作成時に複数の関連カテゴリを提案
- 信頼度スコア表示
- 推奨entry_point自動設定
- チェックボックスで一括登録

### フローチャート実装

**ライブラリ選択**

- **React Flow**: カスタマイズ性高、インタラクティブ操作可能
- **Mermaid.js**: テキストベース定義、軽量

**推奨**: React Flow（編集機能の拡張性を考慮）

**編集UI機能仕様**

1. **手順追加ボタン**
    - 「＋ 処理を追加」ボタン
    - 「＋ 分岐を追加」ボタン
    - ドラッグ&ドロップで配置
2. **ノード編集機能**
    - ダブルクリックでラベル編集
    - 右クリックメニュー（削除、複製、画像添付）
    - ノード間をクリックで接続
3. **分岐ノード**
    - 2つ以上の出力エッジをサポート
    - エッジに条件ラベル追加可能（「はい」「いいえ」など）
    - ひし形表示で視覚的に区別
4. **ハイライト機能**
    - URLパラメータでhighlightNodeIdを指定
    - 該当ノードの背景色・枠線を強調表示
    - アニメーション効果で注目を促す

## AI支援機能

### 自動タグ提案機能

**実装フロー**

1. マニュアル作成時にタイトルと本文を取得
2. 既存カテゴリツリーとタグ一覧を取得
3. LLMに送信して関連カテゴリを推論
4. 候補をユーザーに提示、選択・編集可能

**プロンプト設計**

- 入力：マニュアルタイトル、本文、既存カテゴリツリー、既存タグ
- 出力：推奨カテゴリID配列、推奨タグ配列、各カテゴリのentry_point
- モデル：GPT-4
- response_format: JSON

**API設計**

- `POST /api/manuals/:manualId/suggest-categories`
- リクエスト：マニュアルID
- レスポンス：カテゴリ候補、信頼度スコア、推奨entry_point

## 実装フェーズ

### Phase 1: MVP - 基本的なマニュアル管理と多経路アクセス

#### 1.1 データベース設計・構築

**テーブル定義**

- `categories`: 再帰的階層構造（1〜5階層）
    - id, name, parent_id, level, path, display_order, created_at, updated_at
    - インデックス: parent_id, path
- `manuals`: マニュアル本体
    - id, title, content (TEXT), flowchart_data (JSONB), version, status, created_by, timestamps
    - インデックス: status
- `category_manuals`: 多対多関連（複数ルート管理の核心）
    - id, category_id, manual_id, entry_point, display_order
    - ユニーク制約: (category_id, manual_id)
    - インデックス: category_id, manual_id
- `tags`: タグマスタ
    - id, name, color, created_at
- `manual_tags`: マニュアル・タグ関連
    - manual_id, tag_id（複合主キー）
- `users`: ユーザー管理
    - id, email, password_hash, name, role, created_at, updated_at

**初期データ投入**

- カテゴリマスタ（L1: 受付、会計、診療補助、レセプト、送迎、書類管理）
- テストユーザー（Admin, Editor, Viewer各1名）

#### 1.2 認証・認可システム

**認証機能**

- JWT発行・検証
- ログイン/ログアウトAPI
- パスワードハッシュ化（bcrypt）
- トークンリフレッシュ機能

**認可機能**

- ロールベースアクセス制御（RBAC）
    - Admin: 全操作可能
    - Editor: マニュアル作成・編集・削除、カテゴリ閲覧
    - Viewer: 全て閲覧のみ
- APIエンドポイントへのミドルウェア適用

#### 1.3 カテゴリ管理機能

**API設計**

- `GET /api/categories`: カテゴリツリー全取得（WITH RECURSIVE使用）
- `GET /api/categories/:id`: 特定カテゴリ詳細
- `GET /api/categories/:id/children`: 子カテゴリ一覧
- `POST /api/categories`: カテゴリ作成（Admin only）
- `PUT /api/categories/:id`: カテゴリ更新（Admin only）
- `DELETE /api/categories/:id`: カテゴリ削除（Admin only）

**UI実装**

- カテゴリツリー表示（階層構造を視覚的に表現）
- 折りたたみ/展開機能
- パンくずリスト
- ドリルダウンナビゲーション

#### 1.4 マニュアル基本機能

**API設計**

- `GET /api/manuals`: マニュアル一覧（ページネーション、フィルタ対応）
- `GET /api/manuals/:id`: マニュアル詳細取得
- `POST /api/manuals`: マニュアル作成
- `PUT /api/manuals/:id`: マニュアル更新
- `DELETE /api/manuals/:id`: マニュアル削除
- `GET /api/categories/:categoryId/manuals`: カテゴリ内マニュアル一覧

**Markdown対応**

- エディタ統合（プレビュー機能付き）
- 画像埋め込み構文サポート
- リンク埋め込み
- テーブル、リスト、見出し対応

**フローチャート表示（静的）**

- Mermaid.js統合
- JSONデータからMermaid記法への変換
- ノードタイプ対応（process, decision, start, end）
- エッジラベル表示

#### 1.5 タグ管理機能

**API設計**

- `GET /api/tags`: タグ一覧
- `POST /api/tags`: タグ作成
- `POST /api/manuals/:id/tags`: マニュアルにタグ追加
- `DELETE /api/manuals/:id/tags/:tagId`: タグ削除

**UI実装**

- タグ選択UI（ドロップダウン + 新規作成）
- タグ表示（色付きラベル）
- タグフィルタ機能

#### 1.6 複数ルート管理機能

**API設計**

- `POST /api/manuals/:manualId/categories`: カテゴリ追加
    - リクエスト: { categoryId, entryPoint }
    - バリデーション: カテゴリ存在確認、entry_pointがフローチャート内に存在するか
- `GET /api/manuals/:manualId/categories`: 登録済みカテゴリ一覧
    - レスポンス: カテゴリ情報、パス、entry_point含む
- `PUT /api/manuals/:manualId/categories/:categoryId`: entry_point更新
- `DELETE /api/manuals/:manualId/categories/:categoryId`: カテゴリ削除

**UI実装**

- カテゴリ管理タブ
- 登録済みカテゴリ一覧表示（カード形式）
    - カテゴリパス表示
    - entry_point表示
    - 削除ボタン
- カテゴリ追加モーダル
    - カテゴリツリー選択
    - entry_point選択（フローチャートノード一覧）
    - 追加ボタン

**データ整合性**

- カテゴリ削除時のcascade処理
- マニュアル削除時の関連データクリーンアップ
- entry_point参照整合性チェック

### Phase 2: 動的表示とAI統合

#### 2.1 React Flow統合

**フローチャート描画エンジン**

- React Flowライブラリ統合
- カスタムノードコンポーネント
    - ProcessNode: 長方形、影付き
    - DecisionNode: ひし形、回転CSS
    - StartNode: 丸型、太枠
    - EndNode: 二重丸
- エッジカスタマイズ
    - ラベル表示
    - 矢印スタイル
    - 条件分岐の視覚的区別

**動的ハイライト機能**

- URLパラメータ解析
    - `?from=categoryId&node=nodeId`
- ハイライト対象ノードの特定
- スタイル適用
    - 背景色変更
    - 枠線強調（3px、オレンジ色）
    - アニメーション効果（パルス）
- 自動スクロール（ハイライトノードを中央表示）

**レスポンシブ対応**

- ズーム機能
- ミニマップ表示
- パン操作（ドラッグで移動）

#### 2.2 複数ルート管理UI強化

**カテゴリ追加フロー改善**

- カテゴリ検索機能
- 最近使用したカテゴリ表示
- entry_pointプレビュー
    - 選択したノードをフローチャート上で強調表示
    - ホバー時に説明表示

**登録済みカテゴリ表示強化**

- ソート機能（カテゴリ名、登録日時）
- フィルタ機能
- 一括削除機能
- entry_point一括更新機能

**視覚的フィードバック**

- 追加成功時のトースト通知
- 削除確認ダイアログ
- ローディング状態表示

#### 2.3 AI統合機能

**OpenAI API統合**

- API キー管理（環境変数）
- レート制限対応
- エラーハンドリング
- タイムアウト設定

**カテゴリ自動提案**

- プロンプト設計
    - システムメッセージ: 医療業務カテゴリの専門家として振る舞う
    - ユーザーメッセージ: マニュアルタイトル、本文、既存カテゴリツリー
    - 出力形式: JSON（カテゴリID配列、信頼度、entry_point）
- レスポンス解析
    - 信頼度スコア（0-1）
    - 推奨カテゴリリスト（最大5件）
    - 各カテゴリの推奨entry_point

**entry_point自動推論**

- フローチャート解析
    - 各ノードのラベルをカテゴリ名と比較
    - テキスト類似度計算
    - 最も関連性の高いノードを特定
- フォールバック
    - 推論失敗時は最初のノードを指定
    - ユーザーが手動で変更可能

**UI実装**

- AI提案パネル
    - 提案カテゴリ一覧（チェックボックス付き）
    - 信頼度バー表示
    - 推奨entry_point表示
    - 一括適用ボタン
- 再提案ボタン
- 提案の保存/破棄

#### 2.4 全文検索機能

**PostgreSQL全文検索**

- `tsvector`カラム追加
    - [manuals.search](http://manuals.search)_vector
- GINインデックス作成
- トリガー設定（更新時に自動再インデックス）
- 日本語対応（pg_bigmまたはMeCab統合検討）

**検索API**

- `GET /api/search?q=keyword&category=&tag=`
- レスポンス
    - マニュアル一覧
    - ハイライト箇所
    - スコア（関連度）
- フィルタ条件
    - カテゴリ
    - タグ
    - ステータス
    - 作成日範囲

**検索UI**

- 検索バー（サジェスト機能）
- 検索結果一覧
    - タイトル、スニペット（ハイライト付き）
    - カテゴリパス
    - タグ
- ソート機能（関連度、更新日時）
- ページネーション

### Phase 3: 高度な機能

#### 3.1 フローチャート編集機能

**ノード追加・編集**

- ツールバー
    - 「＋ 処理を追加」ボタン
    - 「＋ 分岐を追加」ボタン
    - 「＋ 開始」「＋ 終了」ボタン
- ノード作成フロー
    - ボタンクリック → キャンバス上でクリック → ノード配置
    - デフォルトラベル設定
    - 自動ID生成
- ダブルクリック編集
    - ラベル編集モード
    - 説明文入力
    - ノードタイプ変更

**エッジ操作**

- 接続作成
    - ノードのハンドルをドラッグ → 別ノードにドロップ
    - 自動エッジID生成
- ラベル追加
    - エッジクリック → ラベル入力フィールド表示
    - 条件分岐用ラベル（はい/いいえ）
- エッジ削除
    - 選択 → Deleteキー

**レイアウト調整**

- ドラッグ&ドロップでノード移動
- 自動整列機能
    - 縦方向整列
    - 横方向整列
    - グリッドスナップ
- 自動レイアウト
    - 階層レイアウト（Dagre.js統合）
    - ツリーレイアウト

**操作性向上**

- Undo/Redo機能
- コピー&ペースト
- 複数選択
- 右クリックメニュー
    - 削除
    - 複製
    - 色変更
    - 画像添付

**データ永続化**

- 自動保存（5秒間隔）
- 手動保存ボタン
- 変更未保存警告

#### 3.2 画像管理機能

**画像アップロード**

- ドラッグ&ドロップUI
- ファイル選択ダイアログ
- 対応形式: JPEG, PNG, GIF, WebP
- サイズ制限: 10MB
- バリデーション
    - MIMEタイプチェック
    - ファイルサイズチェック
    - 画像破損チェック

**画像処理**

- クライアント側リサイズ（Canvas API）
    - 最大幅: 1920px
    - アスペクト比維持
- サーバー側処理
    - サムネイル生成（200x200, 400x400）
    - 画像最適化（品質調整）
    - WebP変換（オプション）

**ストレージ統合**

- S3互換ストレージ
    - AWS S3
    - Cloudflare R2
    - MinIO（セルフホスト）
- パス管理
    - `/{workspace_id}/{manual_id}/{image_id}.{ext}`
- 署名付きURL生成（セキュアアクセス）

**画像ギャラリー**

- サムネイル一覧
- 並び替え（ドラッグ&ドロップ）
- 削除機能
- 代替テキスト編集
- プレビュー表示（ライトボックス）

**ノードへの画像添付**

- 右クリックメニュー「画像を添付」
- 画像選択モーダル
- ノードデータに画像ID保存
- フローチャート上に小さなアイコン表示
- ホバーでプレビュー

#### 3.3 バージョン管理

**バージョン履歴テーブル**

```sql
CREATE TABLE manual_versions (
  id SERIAL PRIMARY KEY,
  manual_id INTEGER REFERENCES manuals(id),
  version INTEGER NOT NULL,
  title VARCHAR(500),
  content TEXT,
  flowchart_data JSONB,
  created_by INTEGER REFERENCES users(id),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  change_description TEXT
);
```

**バージョン作成**

- 手動保存時に新バージョン作成
- 変更内容の記述（オプション）
- 自動バージョン番号インクリメント

**バージョン比較**

- 差分表示UI
    - サイドバイサイド比較
    - ユニファイド差分
- 変更箇所ハイライト
    - 追加: 緑
    - 削除: 赤
    - 変更: 黄
- フローチャート差分
    - ノード追加/削除/変更を視覚化

**ロールバック機能**

- バージョン選択
- プレビュー表示
- 復元ボタン
    - 新バージョンとして保存（履歴保持）
- 復元確認ダイアログ

#### 3.4 権限・承認ワークフロー

**RBAC強化**

- 権限テーブル

```sql
CREATE TABLE permissions (
  id SERIAL PRIMARY KEY,
  role VARCHAR(50),
  resource VARCHAR(100),
  action VARCHAR(50),
  allowed BOOLEAN DEFAULT true
);
```

- きめ細かい権限制御
    - マニュアル: 閲覧/作成/編集/削除/承認
    - カテゴリ: 閲覧/編集
    - ユーザー: 管理

**承認ワークフロー**

- ステータス管理
    - draft: 下書き
    - pending_review: 承認待ち
    - approved: 承認済み
    - published: 公開中
    - archived: アーカイブ
- 承認申請機能
    - Editor → Admin へ申請
    - コメント付き申請
- 承認/却下機能
    - Adminのみ実行可能
    - 却下理由記入
    - Editorへ通知

**通知機能**

- 通知テーブル

```sql
CREATE TABLE notifications (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id),
  type VARCHAR(50),
  title VARCHAR(255),
  message TEXT,
  link VARCHAR(500),
  read BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

- 通知トリガー
    - 承認申請
    - 承認/却下
    - コメント追加
    - @メンション
- 通知UI
    - ベルアイコン（未読バッジ）
    - 通知リスト
    - クリックで該当ページへ遷移

## 技術スタック詳細

### フロントエンド

- **React 18+**: UIフレームワーク
- **TypeScript**: 型安全性
- **React Flow**: フローチャート描画・編集
- **React Router**: SPA ルーティング
- **TanStack Query**: サーバーステート管理
- **Tailwind CSS**: スタイリング
- **react-markdown**: Markdown レンダリング
- **react-dropzone**: 画像ドラッグ&ドロップアップロード
- **react-image-gallery**: 画像ギャラリー表示

### バックエンド

- **Node.js 20+**: ランタイム
- **Express**: Web フレームワーク
- **TypeScript**: 型安全性
- **Prisma**: ORM
- **PostgreSQL 15+**: データベース
- **OpenAI API**: AI タグ提案

### インフラ・デプロイ

- **Vercel**: フロントエンドホスティング
- **Railway/Render**: バックエンドホスティング
- **Supabase**: PostgreSQL ホスティング（代替案）

## セキュリティ考慮事項

**認証・認可**

- JWT ベースの認証
- ロールベースアクセス制御（RBAC）
    - Admin: 全権限
    - Editor: マニュアル作成・編集
    - Viewer: 閲覧のみ

**データ保護**

- 患者情報を含む可能性があるため、マニュアル内容の暗号化検討
- 定期バックアップ
- 監査ログ記録

## パフォーマンス最適化

**キャッシュ戦略**

- カテゴリツリー: Redis キャッシュ（TTL: 1時間）
- よくアクセスされるマニュアル: CDN キャッシュ
- 全文検索インデックス: PostgreSQL GIN インデックス

**クエリ最適化**

- `WITH RECURSIVE` による階層クエリ最適化
- N+1 問題回避（eager loading）
- ページネーション実装

## 運用・保守

**メトリクス**

- マニュアル閲覧数
- カテゴリ別アクセス頻度
- 検索キーワード分析
- AI タグ提案の採用率

**改善サイクル**

- 月次でアクセスログ分析
- カテゴリ構造の最適化
- AI プロンプトのチューニング

## 今後の拡張可能性

- マニュアル内容の多言語対応
- 音声ガイダンス機能
- モバイルアプリ化
- 他システム（電子カルテ等）との連携
- チャットボットによるマニュアル検索支援

## 開発スケジュール概要

各フェーズの実装内容は上記の通り。期間目安：

- **Phase 1**: 2〜3ヶ月
- **Phase 2**: 1〜2ヶ月
- **Phase 3**: 1〜2ヶ月
- **合計**: 4〜7ヶ月

実装順序は依存関係を考慮し、Phase 1完了後にPhase 2、Phase 2完了後にPhase 3を開始。

## 次のアクション

1. **要件定義の詳細化**
    - 透析クリニック業務の洗い出し
    - カテゴリツリーの具体設計（L1〜L3）
    - ユーザーロール定義
2. **技術検証**
    - React Flow 動作確認
    - PostgreSQL 階層クエリ性能検証
    - OpenAI API レスポンス品質確認
3. **初期データ準備**
    - カテゴリマスタ作成（受付、会計、診療補助、レセプト、送迎など）
    - サンプルマニュアル3件（労災保険、送迎手順、レセプト）
    - テストユーザーアカウント
4. **開発着手判断**
    - スケジュール確定
    - リソース確保
    - Phase 1 開始